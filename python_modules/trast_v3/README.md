# Trast Parser V3

Идеальная версия парсера Trast, объединяющая лучшие практики из всех предыдущих версий с новыми улучшениями для максимальной стабильности.

## Основные улучшения

### 1. Обработка частичных загрузок страниц
- ✅ Функция `reload_page_if_needed` для перезагрузки частично загруженных страниц
- ✅ Детальное определение `partial` статуса страниц
- ✅ Автоматический retry для частичных загрузок

### 2. Улучшенная обработка крашей вкладок
- ✅ Расширенная проверка `is_tab_crashed_error` с множественными индикаторами
- ✅ Функция `recreate_driver_after_crash` для автоматического восстановления
- ✅ Health checks для драйверов

### 3. Retry логика с exponential backoff
- ✅ Retry декораторы с exponential backoff и jitter
- ✅ Специализированные retry для proxy errors и таймаутов
- ✅ Настраиваемые параметры retry

### 4. Circuit Breaker Pattern
- ✅ Автоматическое отключение проблемных прокси
- ✅ Временное исключение из пула при частых ошибках
- ✅ Автоматическое восстановление через время

### 5. Health Checks
- ✅ Периодические проверки работоспособности драйверов
- ✅ Проверка прокси во время парсинга
- ✅ Автоматическое восстановление при деградации

### 6. Метрики и мониторинг
- ✅ Счетчики успешных/неуспешных запросов
- ✅ Время отклика прокси и страниц
- ✅ Статистика ошибок по типам
- ✅ Автоматическое логирование метрик

### 7. Улучшенное управление прокси
- ✅ Fallback стратегии из старой версии
- ✅ Улучшенное кэширование успешных прокси
- ✅ Интеграция с circuit breaker

### 8. Graceful Shutdown
- ✅ Корректное завершение потоков
- ✅ Сохранение прогресса
- ✅ Очистка ресурсов

## Структура проекта

```
trast_v3/
├── main.py                 # Точка входа
├── config.py              # Конфигурация
├── logger.py              # Настройка логирования
├── parser/                # Модули парсинга
│   ├── page_parser.py     # Парсинг страниц с partial handling
│   ├── product_extractor.py
│   └── page_validator.py  # Валидация с partial статусом
├── proxy/                 # Управление прокси
│   ├── sources.py
│   ├── validator.py
│   └── manager.py         # С circuit breaker
├── browser/               # Автоматизация браузера
│   ├── driver_factory.py
│   ├── stealth.py
│   └── driver_manager.py  # С улучшенной обработкой крашей
├── storage/               # Сохранение данных
│   ├── csv_writer.py
│   └── excel_writer.py
├── utils/                 # Утилиты
│   ├── exceptions.py      # Расширенные исключения
│   ├── retry.py           # Retry декораторы
│   ├── circuit_breaker.py # Circuit breaker pattern
│   └── health_check.py    # Health checks
└── metrics/               # Метрики
    └── collector.py       # Сбор метрик
```

## Установка

```bash
# Установка зависимостей
pip3 install -r ../requirements.txt
```

## Запуск

```bash
cd python_modules/trast_v3
python3 main.py
```

## Конфигурация

Основные настройки находятся в `config.py`:

- `NUM_WORKER_THREADS` - количество потоков парсинга (по умолчанию: 3)
- `EMPTY_PAGES_THRESHOLD` - количество пустых страниц для остановки (по умолчанию: 3)
- `MIN_PRODUCTS_FOR_SUCCESS` - минимальное количество товаров для успешного завершения (по умолчанию: 100)
- `PARTIAL_PAGE_RETRIES` - количество попыток перезагрузки частичных страниц (по умолчанию: 2)
- `CIRCUIT_BREAKER_FAILURE_THRESHOLD` - порог ошибок для открытия circuit breaker (по умолчанию: 5)
- `HEALTH_CHECK_INTERVAL` - интервал проверки здоровья (по умолчанию: 60 секунд)
- `METRICS_LOG_INTERVAL` - интервал логирования метрик (по умолчанию: 300 секунд)

## Результаты

- Excel: `storage/app/public/output/trast.xlsx`
- CSV: `storage/app/public/output/trast.csv`
- Логи: `storage/app/public/output/logs-trast/`

## Отличия от V2

1. **Обработка partial страниц** - автоматическая перезагрузка частично загруженных страниц
2. **Circuit Breaker** - автоматическое отключение проблемных прокси
3. **Health Checks** - периодические проверки работоспособности
4. **Метрики** - детальная статистика производительности
5. **Улучшенная обработка крашей** - более надежное восстановление после сбоев
6. **Graceful Shutdown** - корректное завершение работы
7. **Расширенная retry логика** - exponential backoff для всех типов ошибок

## Совместимость

- Результаты в тех же форматах (Excel, CSV)
- Те же пути для выходных файлов
- Совместимый интерфейс запуска
- Использует те же зависимости

