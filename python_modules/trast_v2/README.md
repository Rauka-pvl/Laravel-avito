# Trast Parser V2

Улучшенная версия парсера Trast с модульной архитектурой, улучшенной стабильностью и исправлением всех нюансов.

## Структура проекта

```
trast_v2/
├── main.py                 # Точка входа
├── config.py              # Конфигурация
├── logger.py              # Настройка логирования
├── parser/                # Модули парсинга
│   ├── page_parser.py
│   ├── product_extractor.py
│   └── page_validator.py
├── proxy/                 # Управление прокси
│   ├── sources.py
│   ├── validator.py
│   └── manager.py
├── browser/               # Автоматизация браузера
│   ├── driver_factory.py
│   ├── stealth.py
│   └── driver_manager.py
├── storage/               # Сохранение данных
│   ├── csv_writer.py
│   └── excel_writer.py
└── utils/                 # Утилиты
    ├── exceptions.py
    └── retry.py
```

## Установка

```bash
# Установка зависимостей (используются те же, что и для оригинального парсера)
pip3 install -r ../requirements.txt
```

## Запуск

```bash
cd python_modules/trast_v2
python3 main.py
```

## Основные улучшения

### 1. Модульная архитектура
- Четкое разделение на логические модули
- Легкая поддержка и тестирование
- Переиспользование кода

### 2. Улучшенная обработка ошибок
- Кастомные исключения для разных типов ошибок
- Централизованная обработка
- Graceful degradation

### 3. Управление драйверами
- Фабрика драйверов с автоматическим выбором браузера
- Context managers для автоматической очистки
- Улучшенная обработка крашей вкладок

### 4. Упрощенное управление прокси
- Более простая логика валидации
- Кэширование успешных прокси
- Автоматическое обновление списка

### 5. Улучшенная валидация страниц
- Более точное определение блокировок
- Различение пустых страниц и блокировок
- Улучшенная обработка Cloudflare

### 6. Конфигурация
- Все настройки в одном месте (config.py)
- Поддержка переменных окружения
- Легкая настройка без изменения кода

### 7. Логирование
- Структурированное логирование
- Разные уровни для разных компонентов
- Автоматическое переименование логов по статусу

### 8. Thread safety
- Улучшенные блокировки
- Thread-safe структуры данных
- Корректная обработка конкурентного доступа

## Результаты

- Excel: `storage/app/public/output/trast.xlsx`
- CSV: `storage/app/public/output/trast.csv`
- Логи: `storage/app/public/output/logs-trast/`

## Конфигурация

Основные настройки находятся в `config.py`:

- `NUM_WORKER_THREADS` - количество потоков парсинга (по умолчанию: 3)
- `EMPTY_PAGES_THRESHOLD` - количество пустых страниц для остановки (по умолчанию: 3)
- `MIN_PRODUCTS_FOR_SUCCESS` - минимальное количество товаров для успешного завершения (по умолчанию: 100)
- `PROXY_COUNTRIES` - список стран для фильтрации прокси
- `PAGE_LOAD_TIMEOUT` - таймаут загрузки страницы (секунды)
- И другие...

## Отличия от V1

1. **Модульная структура** - код разделен на логические модули
2. **Упрощенная логика** - убрана избыточная сложность
3. **Лучшая обработка ошибок** - кастомные исключения и централизованная обработка
4. **Улучшенное управление ресурсами** - context managers для драйверов
5. **Более чистый код** - меньше дублирования, лучше читаемость

## Совместимость

- Результаты в тех же форматах (Excel, CSV)
- Те же пути для выходных файлов
- Совместимый интерфейс запуска
- Использует те же зависимости

